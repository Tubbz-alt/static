// Integration of HMRC’s webchat solution

(function () {
  'use strict';
  var root = this,
    $ = root.jQuery;
  if(typeof root.GOVUK === 'undefined') { root.GOVUK = {}; }

  var webchat = {

    MAX_TRAIL_LENGTH: 10,

    trackLocation: function(){
      var govUkStorage = JSON.parse(window.sessionStorage.getItem('GOVUK')) || {};
      if ($.isArray(govUkStorage.webchatTrail)) {
        govUkStorage.webchatTrail.push(document.location);
        govUkStorage.webchatTrail.slice(0 - webchat.MAX_TRAIL_LENGTH);
      } else {
        govUkStorage.webchatTrail = [document.location];
      }
      window.sessionStorage.setItem('GOVUK',JSON.stringify(govUkStorage));
    },

    sendMessage: function(message){
      webchat.$chatFrame.get(0).contentWindow.postMessage(JSON.stringify(message), '<%= ENV['GOVUK_ASSET_ROOT'] %>');
    },

    init: function (){
      var insertionPoint = $('.beta-wrapper').length ? $('.beta-wrapper') : $('.heading-block');
      insertionPoint.after('<div class="webchat-banner"><h2>Talk to an HMRC adviser online</h2><p>You can use web chat instead of calling HMRC’s helpline.</p><a href="#" class="accept">Start web chat</a> <a href="#" class="reject">I’m not interested</a></div>');

      // IE7 can’t access webchat
      if (window.sessionStorage && window.postMessage) {

        // append the current location to the current session set
        webchat.trackLocation();

        // what’s the initialisation condition for loading the web chat?
        if (true) {
          webchat.$chatFrame = $('<iframe sandbox="allow-scripts allow-same-origin allow-popups" class="hidden" />');
          webchat.$banner = $('.webchat-banner');

          // initialise the webchat
          webchat.$chatFrame.attr('src', '<%= asset_path "webchat-iframe.html" %>');
          webchat.$chatFrame.on('load', function() {
            webchat.sendMessage({
              evt: 'load',
              // url: 'https://www.preview.alphagov.co.uk/government/organisations/hm-revenue-customs/contact/self-assessment',
              // title: 'Self%20Assessment:%20general%20enquiries%20-%20Contact%20HMRC%20-%20GOV.UK'
              url: window.location.href,
              title: window.document.title
            });
          });
          webchat.$chatFrame.appendTo('body');

          // hide / show the banner based on status of the webchat
          $(window).on('message', function(e) {
            e = e.originalEvent;
            if (e.origin.match(/gov\.uk$/)) {
              var message = JSON.parse(e.data);

              if (message.evt === 'opened') {
                GOVUK.analytics.trackEvent('webchat', 'opened');
                webchat.$banner.addClass('open');
              } else if (message.evt === 'closed') {
                GOVUK.analytics.trackEvent('webchat', 'closed');
                webchat.$banner.removeClass('open');
              } else if (message.evt === 'error') {
                GOVUK.analytics.trackEvent('webchat', 'error');
              }
            }
          });

          // let a user accept / reject a webchat
          webchat.$banner.on('click', '.accept', function(e) {
            e.preventDefault();
            webchat.sendMessage({ evt: 'accept' });
            GOVUK.analytics.trackEvent('webchat', 'accepted');
          }).on('click', '.reject', function(e) {
            e.preventDefault();
            webchat.sendMessage({ evt: 'reject' });
            GOVUK.analytics.trackEvent('webchat', 'rejected');
          });

        }

      }
    }
  };

  root.GOVUK.webchat = webchat;
}).call(this);
