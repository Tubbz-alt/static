<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
  </head>
  <body>
  <script>

    function isOfferOpen() {
      var ribbonContainer = document.querySelector('#egofr-ribbon-container');
      return ribbonContainer && ribbonContainer.parentNode.style.visibility !== 'hidden';
    }

    function click(element) {
      var event = new MouseEvent('click', {
        'view': window,
        'bubbles': true,
        'cancelable': true
      });
      element.dispatchEvent(event);
    }

    function sendMessage(obj) {
      window.parent.postMessage(JSON.stringify(obj), '<%= Rails.env.development? ? '*' : ENV['GOVUK_WEBSITE_ROOT'] %>');
    }

    function signalOfferStatus() {
      sendMessage({ evt: isOfferOpen() ? 'opened' : 'closed' });
    }

    function loadIFrame(pageURL, pageTitle) {
      var egainScript = egainScript = document.createElement('script');
      egainScript.id = "eGainOffers";
      egainScript.src = 'https://mcb.kcom.com/system/Offers.egain?command=GetRulesJS&egofferpageurl=' + pageURL + '&egofferpagetitle=' + pageTitle + '&egofferpatternchecksum=';
      document.body.appendChild(egainScript);

      egainScript.onload = function () {
        setInterval(signalOfferStatus, 1000);
      };
      egainScript.onerror = function () {
        sendMessage({ evt: 'error' });
      };
    }

    window.addEventListener('message', function (e) {
      if (e.origin.match(/gov\.uk$/)) {
        var message = JSON.parse(e.data);

        if (message.evt === 'load') {
          loadIFrame(message.url, message.title);
        } else if (message.evt === 'accept') {
          click(document.querySelector('.egofr-ribbon-btnOK'));
          signalOfferStatus();
        } else if (message.evt === 'reject') {
          click(document.querySelector('.egofr-ribbon-btnCancel'));
          signalOfferStatus();
        }
      }
    });

  </script>
  </body>
</html>
