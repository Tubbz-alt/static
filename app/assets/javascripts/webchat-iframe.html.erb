<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"/>
    <%= javascript_include_tag 'libs/jquery/jquery-1.11.3.js' %>
  </head>
  <body>
  <script>

  (function () {
    'use strict';

    function isOfferOpen() {
      var ribbonContainer = document.querySelector('#egofr-ribbon-container');
      return ribbonContainer && ribbonContainer.parentNode.style.visibility !== 'hidden';
    }

    function sendMessage(obj) {
      window.parent.postMessage(JSON.stringify(obj), '<%= Rails.env.development? ? '*' : ENV['GOVUK_WEBSITE_ROOT'] %>');
    }

    function signalOfferStatus() {
      sendMessage({ evt: isOfferOpen() ? 'opened' : 'closed' });
    }

    function loadIFrame(pageURL, pageTitle) {
      var src = 'https://mcb.kcom.com/system/Offers.egain?command=GetRulesJS&egofferpageurl=' + pageURL + '&egofferpagetitle=' + pageTitle + '&egofferpatternchecksum=';
      $.getScript(src, function () {
        setInterval(signalOfferStatus, 1000);
      }).fail(function () {
        sendMessage({ evt: 'error' });
      });

    }

    function handleMessage(e) {
      var message;
      e = e.originalEvent;
      if (e.origin.match(/gov\.uk$/) || e.origin.match(/alphagov\.co\.uk$/)) {
        message = JSON.parse(e.data);
        if (message.evt === 'load') {
          loadIFrame(message.url, message.title);
        } else if (message.evt === 'accept') {
          document.querySelector('.egofr-ribbon-btnOK').click();
          signalOfferStatus();
        } else if (message.evt === 'reject') {
          document.querySelector('.egofr-ribbon-btnCancel').click();
          signalOfferStatus();
        }
      }
    }

    $(window).on('message', handleMessage);

  })();

  </script>
  </body>
</html>
